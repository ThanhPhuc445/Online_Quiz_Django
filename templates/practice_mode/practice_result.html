{% extends "base.html" %}
{% block title %}K·∫øt qu·∫£ Luy·ªán t·∫≠p: {{ result.quiz.title }}{% endblock %}

{% block extra_head %}
<style>
    .result-header {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .correct-answer {
        border-left: 4px solid #28a745;
        background-color: #f8fff9;
    }
    .wrong-answer {
        border-left: 4px solid #dc3545;
        background-color: #fff8f8;
    }
    .improvement-badge {
        background-color: #17a2b8;
        color: white;
    }
    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-weight: bold;
        border: 6px solid;
    }
    .score-excellent {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
    }
    .score-good {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
    }
    .score-poor {
        border-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
    }
    .answer-choice {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .answer-correct {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    .answer-wrong {
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    .answer-selected {
        border: 2px solid #007bff;
    }
    .math-formula {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header k·∫øt qu·∫£ -->
    <div class="result-header rounded-3 p-4 mb-4 shadow">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 fw-bold mb-2">
                    <i class="bi bi-arrow-repeat me-2"></i>K·∫øt qu·∫£ luy·ªán t·∫≠p
                </h1>
                <h2 class="h3 mb-0">{{ result.quiz.title }}</h2>
                <p class="mb-0 mt-2 text-muted">
                    <i class="bi bi-book me-1"></i>{{ result.quiz.subject.name }} ‚Ä¢ 
                    <i class="bi bi-clock me-1"></i>{% now "H:i, d/m/Y" %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <!-- Hi·ªÉn th·ªã v√≤ng ƒëi·ªÉm s·ªë -->
                <div class="score-circle 
                    {% if result.score >= 80 %}score-excellent
                    {% elif result.score >= 50 %}score-good
                    {% else %}score-poor{% endif %}">
                    <div class="text-center">
                        <div class="h2 mb-0">{{ result.score|floatformat:0 }}</div>
                        <small>/100</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th·ªëng k√™ chi ti·∫øt -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card text-center border-primary h-100">
                <div class="card-body">
                    <div class="h1 text-primary mb-2">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <h3 class="card-title display-6 fw-bold text-primary">{{ result.correct_answers }}</h3>
                    <p class="card-text">C√¢u tr·∫£ l·ªùi ƒë√∫ng</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning h-100">
                <div class="card-body">
                    <div class="h1 text-warning mb-2">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <h3 class="card-title display-6 fw-bold text-warning">{{ result.total_questions|add:"-result.correct_answers" }}</h3>
                    <p class="card-text">C√¢u tr·∫£ l·ªùi sai</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info h-100">
                <div class="card-body">
                    <div class="h1 text-info mb-2">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <h3 class="card-title display-6 fw-bold text-info">{{ result.total_questions }}</h3>
                    <p class="card-text">T·ªïng s·ªë c√¢u h·ªèi</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success h-100">
                <div class="card-body">
                    <div class="h1 text-success mb-2">
                        <i class="bi bi-percent"></i>
                    </div>
                    <h3 class="card-title display-6 fw-bold text-success">
                        {% widthratio result.correct_answers result.total_questions 100 %}%
                    </h3>
                    <p class="card-text">T·ª∑ l·ªá ch√≠nh x√°c</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Th√¥ng b√°o ƒë√°nh gi√° -->
    <div class="row mb-5">
        <div class="col-12">
            {% if result.score >= 80 %}
            <div class="alert alert-success d-flex align-items-center">
                <i class="bi bi-emoji-smile display-6 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Xu·∫•t s·∫Øc! üéâ</h5>
                    <p class="mb-0">B·∫°n ƒë√£ ho√†n th√†nh r·∫•t t·ªët b√†i luy·ªán t·∫≠p n√†y. Ti·∫øp t·ª•c ph√°t huy nh√©!</p>
                </div>
            </div>
            {% elif result.score >= 50 %}
            <div class="alert alert-warning d-flex align-items-center">
                <i class="bi bi-emoji-neutral display-6 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Kh√° t·ªët! üëç</h5>
                    <p class="mb-0">K·∫øt qu·∫£ kh√° ·ªïn, nh∆∞ng v·∫´n c√≤n room ƒë·ªÉ c·∫£i thi·ªán. H√£y luy·ªán t·∫≠p th√™m!</p>
                </div>
            </div>
            {% else %}
            <div class="alert alert-danger d-flex align-items-center">
                <i class="bi bi-emoji-frown display-6 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">C·∫ßn c·ªë g·∫Øng th√™m! üí™</h5>
                    <p class="mb-0">ƒê·ª´ng n·∫£n ch√≠! H√£y √¥n t·∫≠p l·∫°i v√† th·ª≠ l·∫°i ƒë·ªÉ c·∫£i thi·ªán k·∫øt qu·∫£.</p>
                </div>
            </div>
            {% endif %}

            {% if result.improvement and result.improvement > 0 %}
            <div class="alert alert-info d-flex align-items-center mt-3">
                <i class="bi bi-graph-up-arrow display-6 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Ti·∫øn b·ªô ƒë√°ng k·ªÉ! üìà</h5>
                    <p class="mb-0">ƒêi·ªÉm s·ªë c·ªßa b·∫°n ƒë√£ tƒÉng <strong>{{ result.improvement }}%</strong> so v·ªõi l·∫ßn tr∆∞·ªõc.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="d-flex flex-wrap gap-3 mb-5 p-4 bg-light rounded-3 justify-content-center">
        <a href="{% url 'quiz:practice_quiz' result.quiz.id %}" class="btn btn-warning btn-lg px-4">
            <i class="bi bi-arrow-repeat me-2"></i>Luy·ªán t·∫≠p l·∫°i
        </a>
        <a href="{% url 'quiz:practice_selection' %}" class="btn btn-primary btn-lg px-4">
            <i class="bi bi-list-ul me-2"></i>Ch·ªçn ƒë·ªÅ kh√°c
        </a>
        <a href="{% url 'quiz:practice_history' %}" class="btn btn-info btn-lg px-4">
            <i class="bi bi-clock-history me-2"></i>L·ªãch s·ª≠ luy·ªán t·∫≠p
        </a>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg px-4">
            <i class="bi bi-house me-2"></i>V·ªÅ Dashboard
        </a>
    </div>

    <!-- Chi ti·∫øt b√†i l√†m -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
            <h3 class="mb-0">
                <i class="bi bi-card-checklist me-2"></i>Chi ti·∫øt b√†i l√†m
                <span class="badge bg-primary ms-2">{{ result.total_questions }} c√¢u</span>
            </h3>
        </div>
        <div class="card-body p-0">
            {% for item in result.detailed_answers %}
            <div class="card m-3 {% if item.is_correct %}correct-answer{% else %}wrong-answer{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center 
                    {% if item.is_correct %}bg-success text-white{% else %}bg-danger text-white{% endif %}">
                    <div class="d-flex align-items-center">
                        <strong class="me-3">C√¢u {{ forloop.counter }}</strong>
                        <span class="question-preview">{{ item.question.text|truncatewords:10 }}</span>
                    </div>
                    <div>
                        {% if item.is_correct %}
                        <span class="badge bg-light text-success fs-6">
                            <i class="bi bi-check-circle-fill me-1"></i>ƒê√öNG
                        </span>
                        {% else %}
                        <span class="badge bg-light text-danger fs-6">
                            <i class="bi bi-x-circle-fill me-1"></i>SAI
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- N·ªôi dung c√¢u h·ªèi -->
                    <div class="question-content mb-4">
                        <h6 class="text-muted mb-3">N·ªôi dung c√¢u h·ªèi:</h6>
                        {% if '$' in item.question.text or '\\(' in item.question.text or '$$' in item.question.text %}
                        <div class="math-formula">
                            {{ item.question.text|linebreaksbr }}
                        </div>
                        {% else %}
                        <div class="p-3 bg-light rounded">
                            <p class="fs-5 mb-0">{{ item.question.text|linebreaksbr }}</p>
                        </div>
                        {% endif %}
                    </div>

                    {% if item.is_short_answer %}
                    <!-- C√¢u h·ªèi t·ª± lu·∫≠n -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark d-flex align-items-center">
                                    <i class="bi bi-pencil me-2"></i>
                                    <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n</strong>
                                </div>
                                <div class="card-body">
                                    {% if item.student_answer_text %}
                                        <p class="mb-0">{{ item.student_answer_text|linebreaksbr }}</p>
                                    {% else %}
                                        <p class="text-muted mb-0 fst-italic">Ch∆∞a tr·∫£ l·ªùi</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white d-flex align-items-center">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>ƒê√°p √°n m·∫´u</strong>
                                </div>
                                <div class="card-body">
                                    {% if item.correct_answer_text %}
                                        <p class="mb-0">{{ item.correct_answer_text|linebreaksbr }}</p>
                                    {% else %}
                                        <p class="text-muted mb-0 fst-italic">Kh√¥ng c√≥ ƒë√°p √°n m·∫´u</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <!-- C√¢u h·ªèi c√≥ l·ª±a ch·ªçn -->
                    <div class="answer-comparison">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <h6 class="text-warning mb-3 d-flex align-items-center">
                                    <i class="bi bi-person-check me-2"></i>L·ª±a ch·ªçn c·ªßa b·∫°n:
                                </h6>
                                {% if item.student_answer %}
                                    <div class="answer-choice {% if not item.is_correct %}answer-wrong answer-selected{% endif %}">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-record-fill text-danger me-2"></i>
                                            <span>{{ item.student_answer.text }}</span>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="answer-choice bg-light">
                                        <span class="text-muted fst-italic">Kh√¥ng ch·ªçn ƒë√°p √°n n√†o</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success mb-3 d-flex align-items-center">
                                    <i class="bi bi-check-circle me-2"></i>ƒê√°p √°n ƒë√∫ng:
                                </h6>
                                {% if item.correct_answer %}
                                    <div class="answer-choice answer-correct">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>{{ item.correct_answer.text }}</span>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="answer-choice bg-light">
                                        <span class="text-muted fst-italic">Kh√¥ng c√≥ ƒë√°p √°n ƒë√∫ng</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Hi·ªÉn th·ªã t·∫•t c·∫£ ƒë√°p √°n cho c√¢u h·ªèi multiple choice -->
                        {% if item.question_type == 'MULTIPLE_CHOICE' and item.all_answers %}
                        <div class="mt-4">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-list-check me-2"></i>T·∫•t c·∫£ l·ª±a ch·ªçn:
                            </h6>
                            <div class="row g-2">
                                {% for answer in item.all_answers %}
                                <div class="col-md-6">
                                    <div class="answer-choice 
                                        {% if answer.is_correct %}answer-correct{% endif %}
                                        {% if answer.id in item.student_selected_answers and not answer.is_correct %}answer-wrong{% endif %}">
                                        <div class="d-flex align-items-center">
                                            {% if answer.is_correct %}
                                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            {% elif answer.id in item.student_selected_answers %}
                                                <i class="bi bi-x-circle-fill text-danger me-2"></i>
                                            {% else %}
                                                <i class="bi bi-circle text-muted me-2"></i>
                                            {% endif %}
                                            <span>{{ answer.text }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Gi·∫£i th√≠ch (n·∫øu c√≥) -->
                    {% if item.question.explanation %}
                    <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
                        <h6 class="text-info d-flex align-items-center mb-2">
                            <i class="bi bi-info-circle me-2"></i>Gi·∫£i th√≠ch:
                        </h6>
                        <p class="mb-0">{{ item.question.explanation }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- N√∫t cu·ªëi trang -->
    <div class="text-center mt-5 p-5 bg-light rounded-3">
        <h4 class="mb-4">Ti·∫øp t·ª•c h√†nh tr√¨nh luy·ªán t·∫≠p c·ªßa b·∫°n!</h4>
        <div class="d-flex flex-wrap gap-3 justify-content-center">
            <a href="{% url 'quiz:practice_quiz' result.quiz.id %}" class="btn btn-warning btn-lg px-5">
                <i class="bi bi-arrow-repeat me-2"></i>Luy·ªán t·∫≠p l·∫°i
            </a>
            <a href="{% url 'quiz:practice_selection' %}" class="btn btn-primary btn-lg px-5">
                <i class="bi bi-list-ul me-2"></i>ƒê·ªÅ thi kh√°c
            </a>
            <a href="{% url 'quiz:practice_random' %}" class="btn btn-success btn-lg px-5">
                <i class="bi bi-shuffle me-2"></i>ƒê·ªÅ ng·∫´u nhi√™n
            </a>
        </div>
    </div>
</div>

<!-- MathJax -->
<script>
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
    },
    svg: {
        fontCache: 'global'
    }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // T·ª± ƒë·ªông render l·∫°i MathJax sau khi load trang
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
    
    // Th√™m hi·ªáu ·ª©ng scroll m∆∞·ª£t khi click v√†o c√°c ph·∫ßn
    const questionCards = document.querySelectorAll('.card.correct-answer, .card.wrong-answer');
    questionCards.forEach(card => {
        card.addEventListener('click', function() {
            this.classList.toggle('shadow');
        });
    });
});
</script>
{% endblock %}