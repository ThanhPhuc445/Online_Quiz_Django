{% extends "base.html" %}
{% load static %}

{% block extra_head %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<!-- MathJax -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
{% endblock %}

{% block title %}
    {% if is_edit %}Chỉnh sửa câu hỏi{% else %}Thêm câu hỏi mới{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hiển thị thông báo lỗi -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <h1 class="mb-4">
        {% if is_edit %}
            <i class="bi bi-pencil-square"></i> Chỉnh sửa câu hỏi
        {% else %}
            <i class="bi bi-plus-circle"></i> Thêm câu hỏi mới
        {% endif %}
    </h1>

    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <!-- Card thông tin chung -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin câu hỏi</h5>
            </div>
            <div class="card-body">
                <!-- Môn học -->
                <div class="mb-3">
                    <label for="{{ form.subject.id_for_label }}" class="form-label fw-bold">
                        {{ form.subject.label }}
                    </label>
                    {{ form.subject }}
                    {% if form.subject.errors %}
                        <div class="text-danger small mt-1">{{ form.subject.errors }}</div>
                    {% endif %}
                </div>

                <!-- Nội dung câu hỏi -->
                <div class="mb-3">
                    <label for="{{ form.text.id_for_label }}" class="form-label fw-bold">
                        {{ form.text.label }}
                    </label>
                    {{ form.text }}
                    {% if form.text.errors %}
                        <div class="text-danger small mt-1">{{ form.text.errors }}</div>
                    {% endif %}
                    <div class="form-text">
                        Hỗ trợ công thức toán học với MathJax. Ví dụ: $x^2 + y^2 = z^2$, $\frac{a}{b}$, $\int_0^1 f(x)dx$
                    </div>
                </div>

                <!-- TOOLBAR CÔNG THỨC TOÁN HỌC -->
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-light">
                        <i class="bi bi-calculator me-2"></i>Công thức toán học
                        <small class="text-muted ms-2">(Nhấn để chèn vào câu hỏi hoặc đáp án)</small>
                    </div>
                    <div class="card-body p-3">
                        <!-- Hàng 1: Cơ bản -->
                        <div class="math-toolbar mb-3">
                            <small class="text-muted d-block mb-1">Cơ bản:</small>
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-primary math-btn" data-insert="x^{2}">
                                    <strong>x²</strong>
                                </button>
                                <button type="button" class="btn btn-outline-primary math-btn" data-insert="x_{1}">
                                    x₁
                                </button>
                                <button type="button" class="btn btn-outline-primary math-btn" data-insert="\frac{a}{b}">
                                    ¼
                                </button>
                                <button type="button" class="btn btn-outline-primary math-btn" data-insert="\sqrt{x}">
                                    √
                                </button>
                                <button type="button" class="btn btn-outline-primary math-btn" data-insert="\sqrt[n]{x}">
                                    ⁿ√
                                </button>
                            </div>
                        </div>

                        <!-- Hàng 2: Ký hiệu Hy Lạp -->
                        <div class="math-toolbar mb-3">
                            <small class="text-muted d-block mb-1">Ký hiệu:</small>
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-success math-btn" data-insert="\pi">π</button>
                                <button type="button" class="btn btn-outline-success math-btn" data-insert="\alpha">α</button>
                                <button type="button" class="btn btn-outline-success math-btn" data-insert="\beta">β</button>
                                <button type="button" class="btn btn-outline-success math-btn" data-insert="\theta">θ</button>
                                <button type="button" class="btn btn-outline-success math-btn" data-insert="\infty">∞</button>
                            </div>
                        </div>

                        <!-- Hàng 3: Toán học -->
                        <div class="math-toolbar mb-3">
                            <small class="text-muted d-block mb-1">Toán học:</small>
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-info math-btn" data-insert="\sum_{i=1}^{n}">∑</button>
                                <button type="button" class="btn btn-outline-info math-btn" data-insert="\int_{a}^{b}">∫</button>
                                <button type="button" class="btn btn-outline-info math-btn" data-insert="\lim_{x \to \infty}">lim</button>
                                <button type="button" class="btn btn-outline-info math-btn" data-insert="\pm">±</button>
                                <button type="button" class="btn btn-outline-info math-btn" data-insert="\neq">≠</button>
                            </div>
                        </div>

                        <!-- Hàng 4: So sánh -->
                        <div class="math-toolbar">
                            <small class="text-muted d-block mb-1">So sánh:</small>
                            <div class="btn-group btn-group-sm flex-wrap" role="group">
                                <button type="button" class="btn btn-outline-warning math-btn" data-insert="\leq">≤</button>
                                <button type="button" class="btn btn-outline-warning math-btn" data-insert="\geq">≥</button>
                                <button type="button" class="btn btn-outline-warning math-btn" data-insert="\approx">≈</button>
                                <button type="button" class="btn btn-outline-warning math-btn" data-insert="\cdot">·</button>
                                <button type="button" class="btn btn-outline-warning math-btn" data-insert="\times">×</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- KẾT THÚC TOOLBAR -->

                <!-- Loại câu hỏi -->
                <div class="mb-3">
                    <label for="{{ form.question_type.id_for_label }}" class="form-label fw-bold">
                        {{ form.question_type.label }}
                    </label>
                    {{ form.question_type }}
                    {% if form.question_type.errors %}
                        <div class="text-danger small mt-1">{{ form.question_type.errors }}</div>
                    {% endif %}
                </div>

                <!-- Độ khó -->
                <div class="mb-3">
                    <label for="{{ form.difficulty.id_for_label }}" class="form-label fw-bold">
                        {{ form.difficulty.label }}
                    </label>
                    {{ form.difficulty }}
                    {% if form.difficulty.errors %}
                        <div class="text-danger small mt-1">{{ form.difficulty.errors }}</div>
                    {% endif %}
                </div>

                <!-- Đáp án tự luận (chỉ hiện cho câu hỏi tự luận) -->
                <div class="mb-3 field-correct_answer_text" id="correct-answer-field" style="display: none;">
                    <label for="{{ form.correct_answer_text.id_for_label }}" class="form-label fw-bold">
                        {{ form.correct_answer_text.label }}
                    </label>
                    {{ form.correct_answer_text }}
                    {% if form.correct_answer_text.errors %}
                        <div class="text-danger small mt-1">{{ form.correct_answer_text.errors }}</div>
                    {% endif %}
                    <div class="form-text">Nhập đáp án mẫu cho câu hỏi tự luận.</div>
                </div>
            </div>
        </div>

        <!-- Card các đáp án (chỉ hiện cho câu hỏi trắc nghiệm) -->
        <div class="card mb-4" id="answers-section">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Các đáp án</h5>
                <small id="answer-instruction">(Cần chọn chính xác 1 đáp án đúng)</small>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                {% if formset.non_form_errors %}
                    <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
                {% endif %}

                <div id="answers-container">
                    {% for answer_form in formset %}
                        <div class="answer-form-row mb-3" data-index="{{ forloop.counter0 }}">
                            {{ answer_form.id }}
                            <div class="input-group has-validation">
                                <span class="input-group-text">{{ forloop.counter }}</span>
                                {{ answer_form.text }}
                                <div class="input-group-text">
                                    <div class="form-check m-0">
                                        <input type="checkbox" 
                                               name="answers-{{ forloop.counter0 }}-is_correct" 
                                               id="id_answers-{{ forloop.counter0 }}-is_correct"
                                               class="form-check-input answer-correct-checkbox"
                                               {% if answer_form.is_correct.value %}checked{% endif %}
                                               value="true">
                                        <label for="id_answers-{{ forloop.counter0 }}-is_correct" class="form-check-label ms-2">Đúng</label>
                                    </div>
                                </div>
                            </div>
                            {% if answer_form.errors %}
                                <div class="alert alert-warning p-2 small mt-1">
                                    {{ answer_form.errors }}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Nút hành động -->
        <div class="d-flex gap-2 mb-5">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle me-2"></i>
                {% if is_edit %}Cập nhật{% else %}Thêm câu hỏi{% endif %}
            </button>
            <a href="{% url 'quiz:question_list' %}" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle me-2"></i>Hủy bỏ
            </a>
        </div>
    </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionTypeSelect = document.getElementById('id_question_type');
    const answersSection = document.getElementById('answers-section');
    const correctAnswerField = document.getElementById('correct-answer-field');
    const answerInstruction = document.getElementById('answer-instruction');
    
    // ========== TOOLBAR TOÁN HỌC ==========
    function setupMathToolbar() {
        const mathButtons = document.querySelectorAll('.math-btn');
        
        function insertAtCursor(textarea, value) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            
            textarea.value = text.substring(0, start) + value + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + value.length;
            textarea.focus();
            
            // Kích hoạt sự kiện input
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        function getActiveTextarea() {
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.id === 'id_text' || 
                activeElement.id === 'id_correct_answer_text' || 
                activeElement.classList.contains('answer-text'))) {
                return activeElement;
            }
            return document.getElementById('id_text');
        }
        
        mathButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const value = this.getAttribute('data-insert');
                const textarea = getActiveTextarea();
                
                if (textarea) {
                    insertAtCursor(textarea, value);
                }
            });
        });
    }

    // ========== XỬ LÝ CHECKBOX ĐÁP ÁN ĐÚNG ==========
    function setupAnswerCheckboxes() {
        const checkboxes = document.querySelectorAll('.answer-correct-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.disabled = false;
            if (!checkbox.value) {
                checkbox.value = "true";
            }
            
            checkbox.addEventListener('change', function() {
                const questionType = questionTypeSelect.value;
                
                if (questionType === 'SINGLE_CHOICE' || questionType === 'TRUE_FALSE') {
                    if (this.checked) {
                        checkboxes.forEach(cb => {
                            if (cb !== this) {
                                cb.checked = false;
                            }
                        });
                    }
                }
            });
        });
    }
    
    // ========== XỬ LÝ HIỂN THỊ FORM THEO LOẠI CÂU HỎI ==========
    function toggleFormFields() {
        const selectedType = questionTypeSelect.value;
        
        if (selectedType === 'SHORT_ANSWER') {
            // Câu hỏi tự luận
            correctAnswerField.style.display = 'block';
            answersSection.style.display = 'none';
        } else {
            // Câu hỏi trắc nghiệm
            correctAnswerField.style.display = 'none';
            answersSection.style.display = 'block';
            
            // Xử lý đặc biệt cho câu hỏi Đúng/Sai
            if (selectedType === 'TRUE_FALSE') {
                handleTrueFalseAnswers();
            } else {
                enableAnswerEditing();
            }
        }
        
        updateAnswerInstructions(selectedType);
        setupAnswerCheckboxes();
        
        // Render lại MathJax
        setTimeout(() => {
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }, 100);
    }
    
    function handleTrueFalseAnswers() {
        const answerInputs = document.querySelectorAll('.answer-text');
        const answerRows = document.querySelectorAll('.answer-form-row');
        
        answerRows.forEach((row, index) => {
            if (index < 2) {
                row.style.display = 'block';
                if (answerInputs[index]) {
                    answerInputs[index].value = index === 0 ? 'Đúng' : 'Sai';
                    answerInputs[index].readOnly = true;
                }
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function enableAnswerEditing() {
        const answerInputs = document.querySelectorAll('.answer-text');
        const answerRows = document.querySelectorAll('.answer-form-row');
        
        answerRows.forEach(row => row.style.display = 'block');
        answerInputs.forEach(input => {
            if (input) input.readOnly = false;
        });
    }
    
    function updateAnswerInstructions(type) {
        const instructions = {
            'SINGLE_CHOICE': '(Cần chọn chính xác 1 đáp án đúng)',
            'MULTIPLE_CHOICE': '(Có thể chọn nhiều đáp án đúng)',
            'TRUE_FALSE': '(Chọn 1 trong 2 đáp án Đúng/Sai)',
            'SHORT_ANSWER': '(Câu hỏi tự luận)'
        };
        if (answerInstruction) {
            answerInstruction.textContent = instructions[type] || '(Cần chọn đáp án đúng)';
        }
    }
    
    // Khởi tạo
    toggleFormFields();
    setupMathToolbar();
    setupAnswerCheckboxes();
    
    // Render MathJax lần đầu
    setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    }, 500);
    
    questionTypeSelect.addEventListener('change', toggleFormFields);
});
</script>

<style>
.answer-form-row {
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
}

.answer-form-row:last-child {
    border-bottom: none;
}

.form-check-input {
    transform: scale(1.2);
    cursor: pointer;
}

.field-correct_answer_text textarea {
    min-height: 100px;
}

.answer-text {
    min-width: 70%;
}

.input-group-text:first-child {
    min-width: 40px;
    justify-content: center;
    font-weight: bold;
}

/* TOOLBAR TOÁN HỌC */
.math-toolbar .btn-group {
    gap: 4px;
}

.math-toolbar .btn {
    min-width: 50px;
    font-weight: 500;
    border-radius: 6px !important;
    transition: all 0.2s ease;
}

.math-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.math-toolbar .btn-outline-primary {
    border-color: #0d6efd;
    color: #0d6efd;
}

.math-toolbar .btn-outline-success {
    border-color: #198754;
    color: #198754;
}

.math-toolbar .btn-outline-info {
    border-color: #0dcaf0;
    color: #0dcaf0;
}

.math-toolbar .btn-outline-warning {
    border-color: #ffc107;
    color: #ffc107;
}

.form-check-label {
    cursor: pointer;
    user-select: none;
}

.card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
}
</style>
{% endblock %}