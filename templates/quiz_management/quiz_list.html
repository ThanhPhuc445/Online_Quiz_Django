{% extends "base.html" %}
{% load static %}

{% block title %}Thư viện Đề thi{% endblock %}

{% block extra_head %}
<style>
    /* --- CHỈ GIỮ LẠI CSS CHO BẢNG VÀ NÚT (Xóa CSS Badge cũ đi) --- */

    .table-modern th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
        font-weight: 600;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem;
    }
    .table-modern td {
        padding: 1rem;
        vertical-align: middle;
        color: #334155;
        border-bottom: 1px solid #f1f5f9;
    }
    .table-modern tr:hover td {
        background-color: #fffbfb; 
    }

    /* Code box */
    .code-copy-wrapper {
        display: inline-flex;
        align-items: center;
        background: #fff;
        border: 1px dashed #94a3b8;
        border-radius: 4px;
        padding: 2px 8px;
        width: fit-content;
        transition: all 0.2s;
        cursor: pointer;
    }
    .code-copy-wrapper:hover {
        background: #fff;
        border-color: var(--primary-color);
        color: var(--primary-color);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .code-text {
        font-family: 'Courier New', monospace;
        font-weight: 700;
        letter-spacing: 1px;
        margin-right: 8px;
        font-size: 0.9rem;
    }

    /* Action buttons */
    .btn-icon {
        width: 32px; height: 32px;
        display: inline-flex;
        align-items: center; justify-content: center;
        border-radius: 8px;
        color: #64748b;
        transition: all 0.2s;
        text-decoration: none;
    }
    .btn-icon:hover { background-color: #f1f5f9; }
    .btn-icon.edit:hover { color: #0ea5e9; background-color: #e0f2fe; }
    .btn-icon.delete:hover { color: #ef4444; background-color: #fee2e2; }
    .btn-icon.result:hover { color: #10b981; background-color: #d1fae5; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Thư viện Đề thi</h2>
            <p class="text-muted small mb-0">Quản lý danh sách các bài kiểm tra đã tạo.</p>
        </div>
        <a href="{% url 'quiz:quiz_create' %}" class="btn btn-danger shadow-sm px-4 fw-bold" style="background-color: #880000; border: none;">
            <i class="bi bi-plus-lg me-2"></i>Tạo đề mới
        </a>
    </div>

    <!-- TABLE CARD -->
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-modern mb-0 align-middle">
                <thead>
                    <tr>
                        <th class="ps-4">Thông tin đề thi</th>
                        <th>Chế độ truy cập</th>
                        <th>Thời gian</th>
                        <th>Trạng thái</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    {% for quiz in quizzes %}
                    <tr>
                        <!-- 1. Thông tin -->
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded p-2 me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px; background-color: rgba(136, 0, 0, 0.08); color: #880000;">
                                    <i class="bi bi-file-text-fill fs-5"></i>
                                </div>
                                <div>
                                    <a href="{% url 'quiz:quiz_edit' quiz.pk %}" class="fw-bold text-dark text-decoration-none d-block mb-1">
                                        {{ quiz.title }}
                                    </a>
                                    <div class="d-flex gap-2 small text-muted">
                                        <span class="badge bg-light text-dark border fw-normal">{{ quiz.subject.name }}</span>
                                        <span><i class="bi bi-question-circle me-1"></i>{{ quiz.questions.count }} câu</span>
                                        <span><i class="bi bi-clock me-1"></i>{{ quiz.duration_minutes }}p</span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- 2. Chế độ & Mã (ĐÃ SỬA CLASS MÀU) -->
                        <td>
                            {% if quiz.is_public %}
                                <!-- bg-success-subtle: Nền xanh nhạt / text-success-emphasis: Chữ xanh đậm -->
                                <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle rounded-pill px-3 py-2">
                                    <i class="bi bi-globe me-1"></i> Công khai
                                </span>
                            {% else %}
                                <div class="d-flex flex-column align-items-start gap-1">
                                    <!-- bg-warning-subtle: Nền cam nhạt / text-warning-emphasis: Chữ cam đậm -->
                                    <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-pill mb-1">
                                        <i class="bi bi-lock-fill me-1"></i> Riêng tư
                                    </span>
                                    {% if quiz.access_code %}
                                        <div class="code-copy-wrapper" onclick="copyToClipboard('{{ quiz.access_code }}')" title="Bấm để copy mã">
                                            <span class="code-text">{{ quiz.access_code }}</span>
                                            <i class="bi bi-clipboard text-muted" style="font-size: 0.8rem;"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>

                        <!-- 3. Thời gian -->
                        <td>
                            <div class="small text-muted">
                                <div><i class="bi bi-calendar-event me-1"></i> Bắt: {{ quiz.start_time|date:"d/m/Y H:i" }}</div>
                                <div><i class="bi bi-calendar-x me-1"></i> Kết: {{ quiz.end_time|date:"d/m/Y H:i" }}</div>
                            </div>
                        </td>

                        <!-- 4. Trạng thái (ĐÃ SỬA CLASS MÀU) -->
                        <td>
                            {% if quiz.start_time > now %}
                                <!-- Sắp diễn ra: Xanh dương -->
                                <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle rounded-pill px-3">
                                    <i class="bi bi-hourglass-split me-1"></i>Sắp diễn ra
                                </span>
                            {% elif quiz.end_time < now %}
                                <!-- Đã kết thúc: Xám -->
                                <span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle rounded-pill px-3">
                                    <i class="bi bi-check-circle-fill me-1"></i>Đã kết thúc
                                </span>
                            {% else %}
                                <!-- Đang diễn ra: Xanh lá -->
                                <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle rounded-pill px-3">
                                    <span class="spinner-grow spinner-grow-sm me-1" style="width: 0.5rem; height: 0.5rem;"></span> 
                                    Đang diễn ra
                                </span>
                            {% endif %}
                        </td>

                        <!-- 5. Hành động -->
                        <td class="text-end pe-4">
                            <div class="d-flex justify-content-end gap-1">
                                <a href="{% url 'quiz:quiz_results' quiz.pk %}" class="btn-icon result" title="Xem kết quả" data-bs-toggle="tooltip">
                                    <i class="bi bi-bar-chart-line-fill"></i>
                                </a>
                                <a href="{% url 'quiz:quiz_edit' quiz.pk %}" class="btn-icon edit" title="Chỉnh sửa" data-bs-toggle="tooltip">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="{% url 'quiz:quiz_delete' quiz.pk %}" class="btn-icon delete" title="Xóa" onclick="return confirm('Bạn có chắc chắn muốn xóa đề thi này?');">
                                    <i class="bi bi-trash3"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="opacity-50 mb-3">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                            </div>
                            <h5 class="text-muted">Chưa có đề thi nào</h5>
                            <p class="text-muted small mb-4">Bắt đầu tạo bài kiểm tra đầu tiên ngay bây giờ.</p>
                            <a href="{% url 'quiz:quiz_create' %}" class="btn btn-outline-danger rounded-pill px-4">
                                Tạo đề thi mới
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Footer Phân trang -->
        {% if is_paginated %}
        <div class="card-footer bg-white py-3 border-top-0">
            <!-- Code phân trang giữ nguyên -->
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Tạo Toast
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.bottom = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            toastContainer.innerHTML = `
                <div class="toast show align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle-fill me-2"></i> Đã copy mã: <strong>${text}</strong>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toastContainer);
            setTimeout(() => { toastContainer.remove(); }, 3000);
        });
    }

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}