{% extends "base.html" %}
{% block title %}Đang làm bài: {{ quiz.title }}{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <h1 class="page-title">{{ quiz.title }}</h1>
        <p class="text-muted fs-5"><i class="bi bi-book me-2"></i>{{ quiz.subject.name }}</p>
    </div>
    <div class="col-md-4">
        <div class="card text-center bg-light">
            <div class="card-header">Thời gian còn lại</div>
            <div class="card-body">
                <h2 id="timer" class="display-5 fw-bold m-0" style="color: var(--primary-color);">--:--</h2>
            </div>
        </div>
    </div>
</div>

<form id="quizForm" action="{% url 'quiz:submit_quiz' pk=quiz.pk %}" method="post">
    {% csrf_token %}
    {% for item in shuffled_questions %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between">
            <span>Câu hỏi {{ forloop.counter }}</span>
            <span class="badge bg-secondary">{{ item.question.get_difficulty_display }}</span>
        </div>
        <div class="card-body">
            <p class="fs-5 mb-4">{{ item.question.text }}</p>
            {% for answer in item.answers %}
            <div class="form-check fs-5 mb-3">
                <input class="form-check-input" type="radio" name="question_{{ item.question.id }}" id="answer_{{ answer.id }}" value="{{ answer.id }}" required>
                <label class="form-check-label" for="answer_{{ answer.id }}">
                    {{ answer.text }}
                </label>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary btn-lg w-100 mt-3 py-3"><i class="bi bi-check2-circle me-2"></i>NỘP BÀI VÀ XEM KẾT QUẢ</button>
</form>

<script>
    const duration = {{ quiz.duration_minutes }} * 60;
    const timerElement = document.getElementById('timer');
    const quizForm = document.getElementById('quizForm');
    let timeLeft = duration;

    const timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        timerElement.textContent = `${minutes}:${seconds}`;

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerElement.textContent = "Hết giờ!";
            alert("Đã hết thời gian làm bài. Hệ thống sẽ tự động nộp bài của bạn.");
            quizForm.submit();
        }
    }, 1000);
</script>
{% endblock %}